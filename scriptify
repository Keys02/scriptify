#!/usr/bin/env bash

set -e # exit script if any error is encountered

help() {
cat <<- _EOF_ 
Usage: scriptify [OPTIONS...] [-f [FILE]] [-m [mode]] -- command

Create a file and make it executable and further open the file in your preferred text editior

tl;dr:
  scriptify -f foo.sh                       create a script called foo.sh
  scriptify -f bar.sh -e nvim               create a script called bar.sh and open it in neovim
  scriptify -f foobar.sh -e vscodium        create a script called foobar.sh and open it in vscodium
  scritiify -f foo.sh -d                    create a script called foo.sh and open it using the default editor i.e. \$EDITOR

Options:
  -f, --filename                specify the name of the script to create
  -h, --help                    show help message
  -e, --editor                  preferred editor, one of: nvim, code, vscodium 
  -d, --default-editor          open in default editor i.e. \$EDITOR  

Editor:
  nvim              open the script in neovim
  code              open the file in vscode
  vscodium          open the file in vscodium
  zed               open the file in zed
  
_EOF_
}

parse_editor() {
  case "$1" in
    nvim)
      nvim "$FILENAME"
      ;;
    vscodium)
      vscodium "$FILENAME"
      ;;
    code)
      code "$FILENAME"
      ;;
    zed)
      zed "$FILENAME"
      ;;
    *)
      exit
      ;;
  esac
}

define_editor_env() {
  echo "" >> ~/.profile # add a newline
  echo '# Add default editor' >> ~/.profile # add a comment
  echo "export EDITOR=$REPLY" >> ~/.profile
  source ~/.profile # source the .profile file although changes takes effect after session restart
}

use_def_editor() {
  source ~/.profile # load the $EDITOR env in the login shell
  local default_editor=$(echo $EDITOR) # get the default editor in the $EDITOR env

  if [[ $default_editor == "" ]]; then
    declare -l $REPLY # convert the reply string to lowercase
    echo "Set default editor [nvim, code, vscodium,...]"
    read
    define_editor_env "$REPLY"
    "$REPLY" "$FILENAME"
  else
    "$default_editor" "$FILENAME"
  fi
}

create_file() {
  if [[ -e "$1" ]]; then
  # file already exists
    declare -l $REPLY # convert the reply string to lowercase
    echo "File exists, overwrite? y/n"
    read

    case $REPLY in
    yes | y)       
      echo "" > "$1" && echo '#!/usr/bin/env bash' > "$1" # clear the file content and add shebang line
      ;;
    no | n)        
      exit
      ;;
    *)             
      exit 1
      ;;
    esac
  else
    touch "$1" && chmod u+rx "$1" && echo '#!/usr/bin/env bash' > "$1" #create the file, make it readable and executable and add the shebang line
  fi
}

parse_args() {
  local options=$(getopt -o hf:de: --longoptions help,file:,default-editor,editor: -- "$@")
  eval set -- "$options"
  
  while true; do
    case "$1" in
      -f | --filename)
        shift
        FILENAME="$1"
        create_file "$1" 
        ;;  
      -h | --help)
        help 
        exit
        ;;  
      -e | --editor)
        shift
        parse_editor "$1"
        ;;
      -d | --default-editor)
        use_def_editor "$FILENAME"
        ;;
      --)
        break
        ;;
    esac
    shift
  done
}

# display the help message when given no argument 
if [[ -z "$1" ]]; then
  help
  exit
fi

parse_args "$@" # parse the arguments 